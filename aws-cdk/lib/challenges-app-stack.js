"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChallengesAppStack = void 0;
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const apigw = require("aws-cdk-lib/aws-apigateway");
const path = require("path");
class ChallengesAppStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const projectName = 'challenges-app';
        // DynamoDB tables
        const categoriesTable = new dynamodb.Table(this, 'CategoriesTable', {
            tableName: `${projectName}-categories`,
            partitionKey: { name: 'category_id', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        const challengesTable = new dynamodb.Table(this, 'ChallengesTable', {
            tableName: `${projectName}-challenges`,
            partitionKey: { name: 'challenge_id', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'category_id', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        challengesTable.addGlobalSecondaryIndex({
            indexName: 'CategoryIndex',
            partitionKey: { name: 'category_id', type: dynamodb.AttributeType.STRING },
            projectionType: dynamodb.ProjectionType.ALL,
        });
        // Lambda function factory
        const createLambda = (name, handlerDir, env) => new lambda.Function(this, `${name}Fn`, {
            functionName: `${projectName}-${name}`,
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'index.handler',
            code: lambda.Code.fromAsset(path.join(__dirname, `../lambda/${handlerDir}`)),
            timeout: cdk.Duration.seconds(30),
            environment: env,
        });
        // Lambdas
        const getCategoriesFn = createLambda('get-categories', 'get_categories', {
            CATEGORIES_TABLE: categoriesTable.tableName,
        });
        const getChallengesFn = createLambda('get-challenges', 'get_challenges', {
            CHALLENGES_TABLE: challengesTable.tableName,
        });
        const createChallengeFn = createLambda('create-challenge', 'create_challenge', {
            CHALLENGES_TABLE: challengesTable.tableName,
        });
        const updateChallengeFn = createLambda('update-challenge', 'update_challenge', {
            CHALLENGES_TABLE: challengesTable.tableName,
        });
        const deleteChallengeFn = createLambda('delete-challenge', 'delete_challenge', {
            CHALLENGES_TABLE: challengesTable.tableName,
        });
        // Permissions
        categoriesTable.grantReadData(getCategoriesFn);
        challengesTable.grantReadData(getChallengesFn);
        challengesTable.grantWriteData(createChallengeFn);
        challengesTable.grantWriteData(updateChallengeFn);
        challengesTable.grantWriteData(deleteChallengeFn);
        // API Gateway
        const api = new apigw.RestApi(this, 'ChallengesApi', {
            restApiName: `${projectName}-api`,
            deployOptions: {
                stageName: 'dev',
            },
            defaultCorsPreflightOptions: {
                allowOrigins: apigw.Cors.ALL_ORIGINS,
                allowMethods: apigw.Cors.ALL_METHODS,
            },
        });
        const categories = api.root.addResource('categories');
        categories.addMethod('GET', new apigw.LambdaIntegration(getCategoriesFn));
        const challenges = api.root.addResource('challenges');
        challenges.addMethod('GET', new apigw.LambdaIntegration(getChallengesFn));
        challenges.addMethod('POST', new apigw.LambdaIntegration(createChallengeFn));
        const challengesByCategory = challenges.addResource('{category}');
        const challengeById = challengesByCategory.addResource('{id}');
        challengesByCategory.addMethod('GET', new apigw.LambdaIntegration(getChallengesFn));
        challengeById.addMethod('PUT', new apigw.LambdaIntegration(updateChallengeFn));
        challengeById.addMethod('DELETE', new apigw.LambdaIntegration(deleteChallengeFn));
        new cdk.CfnOutput(this, 'ApiUrl', { value: api.url ?? 'undefined' });
        new cdk.CfnOutput(this, 'CategoriesTableName', { value: categoriesTable.tableName });
        new cdk.CfnOutput(this, 'ChallengesTableName', { value: challengesTable.tableName });
    }
}
exports.ChallengesAppStack = ChallengesAppStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbGxlbmdlcy1hcHAtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGFsbGVuZ2VzLWFwcC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFFbkMscURBQXFEO0FBQ3JELGlEQUFpRDtBQUNqRCxvREFBb0Q7QUFDcEQsNkJBQTZCO0FBRTdCLE1BQWEsa0JBQW1CLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDL0MsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQztRQUVyQyxrQkFBa0I7UUFDbEIsTUFBTSxlQUFlLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRTtZQUNsRSxTQUFTLEVBQUUsR0FBRyxXQUFXLGFBQWE7WUFDdEMsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7WUFDMUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxXQUFXLENBQUMsZUFBZTtZQUNqRCxhQUFhLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPO1NBQ3pDLENBQUMsQ0FBQztRQUVILE1BQU0sZUFBZSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDbEUsU0FBUyxFQUFFLEdBQUcsV0FBVyxhQUFhO1lBQ3RDLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQzNFLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFF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Q3JGLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLEVBQUUsRUFBRSxLQUFLLEVBQUUsZUFBZSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDdkYsQ0FBQztDQUNGO0FBbEdELGdEQWtHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XHJcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xyXG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGInO1xyXG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XHJcbmltcG9ydCAqIGFzIGFwaWd3IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5JztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmV4cG9ydCBjbGFzcyBDaGFsbGVuZ2VzQXBwU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xyXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcclxuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xyXG5cclxuICAgIGNvbnN0IHByb2plY3ROYW1lID0gJ2NoYWxsZW5nZXMtYXBwJztcclxuXHJcbiAgICAvLyBEeW5hbW9EQiB0YWJsZXNcclxuICAgIGNvbnN0IGNhdGVnb3JpZXNUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCAnQ2F0ZWdvcmllc1RhYmxlJywge1xyXG4gICAgICB0YWJsZU5hbWU6IGAke3Byb2plY3ROYW1lfS1jYXRlZ29yaWVzYCxcclxuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6ICdjYXRlZ29yeV9pZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXHJcbiAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXHJcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBjaGFsbGVuZ2VzVGFibGUgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgJ0NoYWxsZW5nZXNUYWJsZScsIHtcclxuICAgICAgdGFibGVOYW1lOiBgJHtwcm9qZWN0TmFtZX0tY2hhbGxlbmdlc2AsXHJcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnY2hhbGxlbmdlX2lkJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcclxuICAgICAgc29ydEtleTogeyBuYW1lOiAnY2F0ZWdvcnlfaWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxyXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxyXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY2hhbGxlbmdlc1RhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcclxuICAgICAgaW5kZXhOYW1lOiAnQ2F0ZWdvcnlJbmRleCcsXHJcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAnY2F0ZWdvcnlfaWQnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxyXG4gICAgICBwcm9qZWN0aW9uVHlwZTogZHluYW1vZGIuUHJvamVjdGlvblR5cGUuQUxMLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gTGFtYmRhIGZ1bmN0aW9uIGZhY3RvcnlcclxuICAgIGNvbnN0IGNyZWF0ZUxhbWJkYSA9IChuYW1lOiBzdHJpbmcsIGhhbmRsZXJEaXI6IHN0cmluZywgZW52PzogUmVjb3JkPHN0cmluZywgc3RyaW5nPikgPT5cclxuICAgICAgbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBgJHtuYW1lfUZuYCwge1xyXG4gICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvamVjdE5hbWV9LSR7bmFtZX1gLFxyXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxyXG4gICAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcclxuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgYC4uL2xhbWJkYS8ke2hhbmRsZXJEaXJ9YCkpLFxyXG4gICAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDMwKSxcclxuICAgICAgICBlbnZpcm9ubWVudDogZW52LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAvLyBMYW1iZGFzXHJcbiAgICBjb25zdCBnZXRDYXRlZ29yaWVzRm4gPSBjcmVhdGVMYW1iZGEoJ2dldC1jYXRlZ29yaWVzJywgJ2dldF9jYXRlZ29yaWVzJywge1xyXG4gICAgICBDQVRFR09SSUVTX1RBQkxFOiBjYXRlZ29yaWVzVGFibGUudGFibGVOYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgZ2V0Q2hhbGxlbmdlc0ZuID0gY3JlYXRlTGFtYmRhKCdnZXQtY2hhbGxlbmdlcycsICdnZXRfY2hhbGxlbmdlcycsIHtcclxuICAgICAgQ0hBTExFTkdFU19UQUJMRTogY2hhbGxlbmdlc1RhYmxlLnRhYmxlTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGNyZWF0ZUNoYWxsZW5nZUZuID0gY3JlYXRlTGFtYmRhKCdjcmVhdGUtY2hhbGxlbmdlJywgJ2NyZWF0ZV9jaGFsbGVuZ2UnLCB7XHJcbiAgICAgIENIQUxMRU5HRVNfVEFCTEU6IGNoYWxsZW5nZXNUYWJsZS50YWJsZU5hbWUsXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVDaGFsbGVuZ2VGbiA9IGNyZWF0ZUxhbWJkYSgndXBkYXRlLWNoYWxsZW5nZScsICd1cGRhdGVfY2hhbGxlbmdlJywge1xyXG4gICAgICBDSEFMTEVOR0VTX1RBQkxFOiBjaGFsbGVuZ2VzVGFibGUudGFibGVOYW1lLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgZGVsZXRlQ2hhbGxlbmdlRm4gPSBjcmVhdGVMYW1iZGEoJ2RlbGV0ZS1jaGFsbGVuZ2UnLCAnZGVsZXRlX2NoYWxsZW5nZScsIHtcclxuICAgICAgQ0hBTExFTkdFU19UQUJMRTogY2hhbGxlbmdlc1RhYmxlLnRhYmxlTmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFBlcm1pc3Npb25zXHJcbiAgICBjYXRlZ29yaWVzVGFibGUuZ3JhbnRSZWFkRGF0YShnZXRDYXRlZ29yaWVzRm4pO1xyXG5cclxuICAgIGNoYWxsZW5nZXNUYWJsZS5ncmFudFJlYWREYXRhKGdldENoYWxsZW5nZXNGbik7XHJcbiAgICBjaGFsbGVuZ2VzVGFibGUuZ3JhbnRXcml0ZURhdGEoY3JlYXRlQ2hhbGxlbmdlRm4pO1xyXG4gICAgY2hhbGxlbmdlc1RhYmxlLmdyYW50V3JpdGVEYXRhKHVwZGF0ZUNoYWxsZW5nZUZuKTtcclxuICAgIGNoYWxsZW5nZXNUYWJsZS5ncmFudFdyaXRlRGF0YShkZWxldGVDaGFsbGVuZ2VGbik7XHJcblxyXG4gICAgLy8gQVBJIEdhdGV3YXlcclxuICAgIGNvbnN0IGFwaSA9IG5ldyBhcGlndy5SZXN0QXBpKHRoaXMsICdDaGFsbGVuZ2VzQXBpJywge1xyXG4gICAgICByZXN0QXBpTmFtZTogYCR7cHJvamVjdE5hbWV9LWFwaWAsXHJcbiAgICAgIGRlcGxveU9wdGlvbnM6IHtcclxuICAgICAgICBzdGFnZU5hbWU6ICdkZXYnLFxyXG4gICAgICB9LFxyXG4gICAgICBkZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnM6IHtcclxuICAgICAgICBhbGxvd09yaWdpbnM6IGFwaWd3LkNvcnMuQUxMX09SSUdJTlMsXHJcbiAgICAgICAgYWxsb3dNZXRob2RzOiBhcGlndy5Db3JzLkFMTF9NRVRIT0RTLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgY2F0ZWdvcmllcyA9IGFwaS5yb290LmFkZFJlc291cmNlKCdjYXRlZ29yaWVzJyk7XHJcbiAgICBjYXRlZ29yaWVzLmFkZE1ldGhvZCgnR0VUJywgbmV3IGFwaWd3LkxhbWJkYUludGVncmF0aW9uKGdldENhdGVnb3JpZXNGbikpO1xyXG5cclxuICAgIGNvbnN0IGNoYWxsZW5nZXMgPSBhcGkucm9vdC5hZGRSZXNvdXJjZSgnY2hhbGxlbmdlcycpO1xyXG4gICAgY2hhbGxlbmdlcy5hZGRNZXRob2QoJ0dFVCcsIG5ldyBhcGlndy5MYW1iZGFJbnRlZ3JhdGlvbihnZXRDaGFsbGVuZ2VzRm4pKTtcclxuICAgIGNoYWxsZW5nZXMuYWRkTWV0aG9kKCdQT1NUJywgbmV3IGFwaWd3LkxhbWJkYUludGVncmF0aW9uKGNyZWF0ZUNoYWxsZW5nZUZuKSk7XHJcblxyXG4gICAgY29uc3QgY2hhbGxlbmdlc0J5Q2F0ZWdvcnkgPSBjaGFsbGVuZ2VzLmFkZFJlc291cmNlKCd7Y2F0ZWdvcnl9Jyk7XHJcbiAgICBjb25zdCBjaGFsbGVuZ2VCeUlkID0gY2hhbGxlbmdlc0J5Q2F0ZWdvcnkuYWRkUmVzb3VyY2UoJ3tpZH0nKTtcclxuXHJcbiAgICBjaGFsbGVuZ2VzQnlDYXRlZ29yeS5hZGRNZXRob2QoJ0dFVCcsIG5ldyBhcGlndy5MYW1iZGFJbnRlZ3JhdGlvbihnZXRDaGFsbGVuZ2VzRm4pKTtcclxuICAgIGNoYWxsZW5nZUJ5SWQuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpZ3cuTGFtYmRhSW50ZWdyYXRpb24odXBkYXRlQ2hhbGxlbmdlRm4pKTtcclxuICAgIGNoYWxsZW5nZUJ5SWQuYWRkTWV0aG9kKCdERUxFVEUnLCBuZXcgYXBpZ3cuTGFtYmRhSW50ZWdyYXRpb24oZGVsZXRlQ2hhbGxlbmdlRm4pKTtcclxuXHJcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnQXBpVXJsJywgeyB2YWx1ZTogYXBpLnVybCA/PyAndW5kZWZpbmVkJyB9KTtcclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdDYXRlZ29yaWVzVGFibGVOYW1lJywgeyB2YWx1ZTogY2F0ZWdvcmllc1RhYmxlLnRhYmxlTmFtZSB9KTtcclxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdDaGFsbGVuZ2VzVGFibGVOYW1lJywgeyB2YWx1ZTogY2hhbGxlbmdlc1RhYmxlLnRhYmxlTmFtZSB9KTtcclxuICB9XHJcbn1cclxuIl19